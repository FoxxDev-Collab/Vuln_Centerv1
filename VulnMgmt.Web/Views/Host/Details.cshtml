@model VulnMgmt.Web.Models.ViewModels.HostDetailsViewModel
@{
    ViewData["Title"] = Model.Host.DisplayName ?? Model.Host.DNSName ?? "Host Details";
}

<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a asp-controller="Site" asp-action="Index">Sites</a></li>
        <li class="breadcrumb-item"><a asp-controller="Site" asp-action="Details" asp-route-id="@Model.Host.SiteId">@Model.Host.Site.Name</a></li>
        <li class="breadcrumb-item active">@ViewData["Title"]</li>
    </ol>
</nav>

@if (TempData["Success"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle me-1"></i>@TempData["Success"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="mb-1">
            <i class="bi bi-pc-display me-2"></i>@ViewData["Title"]
            @switch (Model.Host.Status)
            {
                case VulnMgmt.Web.Models.Domain.HostStatus.Active:
                    <span class="badge bg-success fs-6">Active</span>
                    break;
                case VulnMgmt.Web.Models.Domain.HostStatus.Inactive:
                    <span class="badge bg-secondary fs-6">Inactive</span>
                    break;
                case VulnMgmt.Web.Models.Domain.HostStatus.Decommissioned:
                    <span class="badge bg-dark fs-6">Decommissioned</span>
                    break;
                default:
                    <span class="badge bg-light text-dark fs-6">Unknown</span>
                    break;
            }
        </h1>
        <p class="text-muted mb-0">
            <a asp-controller="Site" asp-action="Details" asp-route-id="@Model.Host.SiteId" class="text-decoration-none">
                <i class="bi bi-building me-1"></i>@Model.Host.Site.Name
            </a>
        </p>
    </div>
    <div>
        @if (User.IsInRole("Admin") || User.IsInRole("ISSM"))
        {
            <a asp-action="Edit" asp-route-id="@Model.Host.Id" class="btn btn-outline-primary">
                <i class="bi bi-pencil me-1"></i>Edit
            </a>
        }
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-2">
        <div class="card bg-danger text-white h-100">
            <div class="card-body text-center">
                <h6 class="text-white-50">Critical</h6>
                <h2 class="mb-0">@Model.Summary.CriticalCount</h2>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card text-white h-100" style="background-color: #fd7e14;">
            <div class="card-body text-center">
                <h6 style="color: rgba(255,255,255,0.7);">High</h6>
                <h2 class="mb-0">@Model.Summary.HighCount</h2>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card bg-warning text-dark h-100">
            <div class="card-body text-center">
                <h6 class="text-dark-50">Medium</h6>
                <h2 class="mb-0">@Model.Summary.MediumCount</h2>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card bg-info text-white h-100">
            <div class="card-body text-center">
                <h6 class="text-white-50">Low</h6>
                <h2 class="mb-0">@Model.Summary.LowCount</h2>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card bg-success text-white h-100">
            <div class="card-body text-center">
                <h6 class="text-white-50">Remediated</h6>
                <h2 class="mb-0">@Model.Summary.RemediatedCount</h2>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card bg-secondary text-white h-100">
            <div class="card-body text-center">
                <h6 class="text-white-50">Accepted</h6>
                <h2 class="mb-0">@Model.Summary.AcceptedCount</h2>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header">
                <i class="bi bi-info-circle me-1"></i>Host Information
            </div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-sm-4">DNS Name</dt>
                    <dd class="col-sm-8"><code>@(Model.Host.DNSName ?? "-")</code></dd>

                    <dt class="col-sm-4">NetBIOS Name</dt>
                    <dd class="col-sm-8"><code>@(Model.Host.NetBIOSName ?? "-")</code></dd>

                    <dt class="col-sm-4">IP Address</dt>
                    <dd class="col-sm-8"><code>@(Model.Host.LastKnownIPAddress ?? "-")</code></dd>

                    <dt class="col-sm-4">MAC Address</dt>
                    <dd class="col-sm-8"><code>@(Model.Host.LastKnownMACAddress ?? "-")</code></dd>

                    <dt class="col-sm-4">Operating System</dt>
                    <dd class="col-sm-8">@(Model.Host.OperatingSystem ?? "-") @Model.Host.OSVersion</dd>

                    <dt class="col-sm-4">Asset Type</dt>
                    <dd class="col-sm-8">@Model.Host.AssetType</dd>
                </dl>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header">
                <i class="bi bi-tag me-1"></i>Asset Details
            </div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-sm-4">Asset Tag</dt>
                    <dd class="col-sm-8">@(Model.Host.AssetTag ?? "-")</dd>

                    <dt class="col-sm-4">Serial Number</dt>
                    <dd class="col-sm-8">@(Model.Host.SerialNumber ?? "-")</dd>

                    <dt class="col-sm-4">Description</dt>
                    <dd class="col-sm-8">@(Model.Host.Description ?? "-")</dd>

                    <dt class="col-sm-4">Last Scan</dt>
                    <dd class="col-sm-8">
                        @if (Model.Host.LastScanDate.HasValue)
                        {
                            @Model.Host.LastScanDate.Value.ToString("MM/dd/yyyy HH:mm")
                        }
                        else
                        {
                            <span class="text-muted">Never scanned</span>
                        }
                    </dd>

                    <dt class="col-sm-4">Created</dt>
                    <dd class="col-sm-8">@Model.Host.CreatedDate.ToString("MM/dd/yyyy")</dd>
                </dl>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-bug me-1"></i>Vulnerabilities (@Model.Summary.OpenCount open of @Model.Summary.TotalVulnerabilities total)</span>
    </div>
    <div class="card-body p-0">
        @if (!Model.Vulnerabilities.Any())
        {
            <div class="p-4 text-center text-muted">
                <i class="bi bi-shield-check display-4"></i>
                <p class="mt-2">No vulnerabilities found for this host.</p>
            </div>
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Severity</th>
                            <th>Plugin</th>
                            <th>Name</th>
                            <th>CVE</th>
                            <th>Port</th>
                            <th class="text-center">Exploitable</th>
                            <th>Status</th>
                            <th>Last Seen</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var vuln in Model.Vulnerabilities)
                        {
                            <tr class="@(vuln.RemediationStatus == VulnMgmt.Web.Models.Domain.RemediationStatus.Remediated || vuln.RemediationStatus == VulnMgmt.Web.Models.Domain.RemediationStatus.Accepted || vuln.RemediationStatus == VulnMgmt.Web.Models.Domain.RemediationStatus.FalsePositive ? "table-light text-muted" : "")">
                                <td>
                                    @switch (vuln.Severity)
                                    {
                                        case VulnMgmt.Web.Models.Domain.Severity.Critical:
                                            <span class="badge bg-danger">Critical</span>
                                            break;
                                        case VulnMgmt.Web.Models.Domain.Severity.High:
                                            <span class="badge" style="background-color: #fd7e14;">High</span>
                                            break;
                                        case VulnMgmt.Web.Models.Domain.Severity.Medium:
                                            <span class="badge bg-warning text-dark">Medium</span>
                                            break;
                                        case VulnMgmt.Web.Models.Domain.Severity.Low:
                                            <span class="badge bg-info">Low</span>
                                            break;
                                        default:
                                            <span class="badge bg-secondary">Info</span>
                                            break;
                                    }
                                </td>
                                <td><code class="small">@vuln.PluginId</code></td>
                                <td>
                                    <a asp-controller="Vulnerability" asp-action="Details" asp-route-id="@vuln.Id" class="text-decoration-none">
                                        @(vuln.PluginName?.Length > 50 ? vuln.PluginName.Substring(0, 47) + "..." : vuln.PluginName)
                                    </a>
                                    @if (!string.IsNullOrEmpty(vuln.Family))
                                    {
                                        <br /><small class="text-muted">@vuln.Family</small>
                                    }
                                </td>
                                <td>
                                    @if (!string.IsNullOrEmpty(vuln.CVE))
                                    {
                                        <code class="small">@vuln.CVE</code>
                                    }
                                    else
                                    {
                                        <span class="text-muted">-</span>
                                    }
                                </td>
                                <td>
                                    @if (vuln.Port.HasValue && vuln.Port > 0)
                                    {
                                        <code class="small">@vuln.Port/@vuln.Protocol</code>
                                    }
                                    else
                                    {
                                        <span class="text-muted">-</span>
                                    }
                                </td>
                                <td class="text-center">
                                    @if (vuln.IsExploitable)
                                    {
                                        <span class="badge bg-danger"><i class="bi bi-exclamation-triangle"></i></span>
                                    }
                                </td>
                                <td>
                                    @switch (vuln.RemediationStatus)
                                    {
                                        case VulnMgmt.Web.Models.Domain.RemediationStatus.Open:
                                            <span class="badge bg-danger">Open</span>
                                            break;
                                        case VulnMgmt.Web.Models.Domain.RemediationStatus.InProgress:
                                            <span class="badge bg-warning text-dark">In Progress</span>
                                            break;
                                        case VulnMgmt.Web.Models.Domain.RemediationStatus.Remediated:
                                            <span class="badge bg-success">Remediated</span>
                                            break;
                                        case VulnMgmt.Web.Models.Domain.RemediationStatus.Accepted:
                                            <span class="badge bg-secondary">Accepted</span>
                                            break;
                                        case VulnMgmt.Web.Models.Domain.RemediationStatus.FalsePositive:
                                            <span class="badge bg-dark">False Positive</span>
                                            break;
                                    }
                                </td>
                                <td class="small">
                                    @if (vuln.LastObserved.HasValue)
                                    {
                                        @vuln.LastObserved.Value.ToString("MM/dd/yy")
                                    }
                                </td>
                                <td>
                                    <a asp-controller="Vulnerability" asp-action="Details" asp-route-id="@vuln.Id" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
</div>
