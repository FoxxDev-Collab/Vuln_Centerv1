@model VulnMgmt.Web.Models.ViewModels.VulnerabilityDetailsViewModel
@using VulnMgmt.Web.Models.Domain
@{
    ViewData["Title"] = Model.Vulnerability.PluginName ?? "Vulnerability Details";

    var severityClass = Model.Vulnerability.Severity switch
    {
        Severity.Critical => "bg-danger",
        Severity.High => "bg-warning text-dark",
        Severity.Medium => "bg-info",
        Severity.Low => "bg-secondary",
        _ => "bg-light text-dark"
    };

    var statusClass = Model.Vulnerability.RemediationStatus switch
    {
        RemediationStatus.Open => "text-bg-danger",
        RemediationStatus.InProgress => "text-bg-primary",
        RemediationStatus.Remediated => "text-bg-success",
        RemediationStatus.Accepted => "text-bg-info",
        RemediationStatus.FalsePositive => "text-bg-secondary",
        _ => ""
    };
}

<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a asp-action="Index">Vulnerabilities</a></li>
        <li class="breadcrumb-item"><a asp-controller="Host" asp-action="Details" asp-route-id="@Model.Vulnerability.HostId">@Model.HostName</a></li>
        <li class="breadcrumb-item active">@(Model.Vulnerability.PluginName ?? "Details")</li>
    </ol>
</nav>

<div class="d-flex justify-content-between align-items-start mb-4">
    <div>
        <h1 class="mb-2">
            <span class="badge @severityClass me-2">@Model.Vulnerability.Severity</span>
            @Model.Vulnerability.PluginName
        </h1>
        <p class="text-muted mb-0">
            <i class="bi bi-pc-display me-1"></i>@Model.HostName
            <span class="mx-2">|</span>
            <i class="bi bi-building me-1"></i>@Model.SiteName
            <span class="mx-2">|</span>
            Plugin ID: @Model.Vulnerability.PluginId
        </p>
    </div>
    <div class="d-flex gap-2">
        <span class="badge @statusClass fs-6">
            @Model.Vulnerability.RemediationStatus
        </span>
        @if (User.IsInRole("Admin") || User.IsInRole("ISSM") || User.IsInRole("ISSO") || User.IsInRole("SysAdmin"))
        {
            <a asp-action="UpdateStatus" asp-route-id="@Model.Vulnerability.Id" class="btn btn-warning">
                <i class="bi bi-pencil me-1"></i>Update Status
            </a>
        }
    </div>
</div>

@if (TempData["Success"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle me-1"></i>@TempData["Success"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<div class="row">
    <div class="col-lg-8">
        <!-- Synopsis -->
        @if (!string.IsNullOrEmpty(Model.Vulnerability.Synopsis))
        {
            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-card-text me-1"></i>Synopsis
                </div>
                <div class="card-body">
                    @Model.Vulnerability.Synopsis
                </div>
            </div>
        }

        <!-- Description -->
        @if (!string.IsNullOrEmpty(Model.Vulnerability.Description))
        {
            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-file-text me-1"></i>Description
                </div>
                <div class="card-body">
                    <pre class="mb-0" style="white-space: pre-wrap; font-family: inherit;">@Model.Vulnerability.Description</pre>
                </div>
            </div>
        }

        <!-- Solution -->
        @if (!string.IsNullOrEmpty(Model.Vulnerability.Solution))
        {
            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-tools me-1"></i>Solution
                </div>
                <div class="card-body">
                    <pre class="mb-0" style="white-space: pre-wrap; font-family: inherit;">@Model.Vulnerability.Solution</pre>
                </div>
            </div>
        }

        <!-- Plugin Output -->
        @if (!string.IsNullOrEmpty(Model.Vulnerability.PluginText))
        {
            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-terminal me-1"></i>Plugin Output
                </div>
                <div class="card-body">
                    <pre class="bg-dark text-light p-3 rounded mb-0" style="max-height: 400px; overflow-y: auto;">@Model.Vulnerability.PluginText</pre>
                </div>
            </div>
        }

        <!-- Remediation Notes -->
        @if (!string.IsNullOrEmpty(Model.Vulnerability.RemediationNotes))
        {
            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-journal-text me-1"></i>Remediation Notes
                </div>
                <div class="card-body">
                    @Model.Vulnerability.RemediationNotes
                </div>
            </div>
        }
    </div>

    <div class="col-lg-4">
        <!-- Details Card -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-info-circle me-1"></i>Details
            </div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-sm-5">Family</dt>
                    <dd class="col-sm-7">@(Model.Vulnerability.Family ?? "-")</dd>

                    <dt class="col-sm-5">Port</dt>
                    <dd class="col-sm-7">
                        @if (Model.Vulnerability.Port.HasValue)
                        {
                            @Model.Vulnerability.Port<text>/</text>@Model.Vulnerability.Protocol
                        }
                        else
                        {
                            <span class="text-muted">-</span>
                        }
                    </dd>

                    <dt class="col-sm-5">IP Address</dt>
                    <dd class="col-sm-7">@(Model.Vulnerability.IPAddress ?? "-")</dd>

                    <dt class="col-sm-5">Exploitable</dt>
                    <dd class="col-sm-7">
                        @if (Model.Vulnerability.IsExploitable)
                        {
                            <span class="badge bg-danger"><i class="bi bi-lightning-fill me-1"></i>Yes</span>
                        }
                        else
                        {
                            <span class="text-muted">No</span>
                        }
                    </dd>

                    @if (!string.IsNullOrEmpty(Model.Vulnerability.ExploitFrameworks))
                    {
                        <dt class="col-sm-5">Exploit Frameworks</dt>
                        <dd class="col-sm-7">@Model.Vulnerability.ExploitFrameworks</dd>
                    }

                    @if (!string.IsNullOrEmpty(Model.Vulnerability.ExploitEase))
                    {
                        <dt class="col-sm-5">Exploit Ease</dt>
                        <dd class="col-sm-7">@Model.Vulnerability.ExploitEase</dd>
                    }
                </dl>
            </div>
        </div>

        <!-- CVE References -->
        @if (!string.IsNullOrEmpty(Model.Vulnerability.CVE))
        {
            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-link-45deg me-1"></i>CVE References
                </div>
                <div class="card-body">
                    @foreach (var cve in Model.Vulnerability.CVE.Split(','))
                    {
                        <a href="https://nvd.nist.gov/vuln/detail/@cve.Trim()" target="_blank" class="btn btn-sm btn-outline-dark mb-1">
                            @cve.Trim() <i class="bi bi-box-arrow-up-right ms-1"></i>
                        </a>
                    }
                </div>
            </div>
        }

        <!-- Timeline -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-clock-history me-1"></i>Timeline
            </div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-sm-5">First Seen</dt>
                    <dd class="col-sm-7">
                        @if (Model.Vulnerability.FirstDiscovered.HasValue)
                        {
                            @Model.Vulnerability.FirstDiscovered.Value.ToString("MM/dd/yyyy")
                        }
                        else
                        {
                            <span class="text-muted">-</span>
                        }
                    </dd>

                    <dt class="col-sm-5">Last Seen</dt>
                    <dd class="col-sm-7">
                        @if (Model.Vulnerability.LastObserved.HasValue)
                        {
                            @Model.Vulnerability.LastObserved.Value.ToString("MM/dd/yyyy")
                        }
                        else
                        {
                            <span class="text-muted">-</span>
                        }
                    </dd>

                    @if (Model.Vulnerability.RemediationDate.HasValue)
                    {
                        <dt class="col-sm-5">Remediated</dt>
                        <dd class="col-sm-7">@Model.Vulnerability.RemediationDate.Value.ToString("MM/dd/yyyy")</dd>
                    }

                    <dt class="col-sm-5">Created</dt>
                    <dd class="col-sm-7">@Model.Vulnerability.CreatedDate.ToString("MM/dd/yyyy")</dd>

                    <dt class="col-sm-5">Modified</dt>
                    <dd class="col-sm-7">@Model.Vulnerability.ModifiedDate.ToString("MM/dd/yyyy")</dd>
                </dl>
            </div>
        </div>

        <!-- See Also -->
        @if (!string.IsNullOrEmpty(Model.Vulnerability.SeeAlso))
        {
            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-link me-1"></i>References
                </div>
                <div class="card-body">
                    @foreach (var link in Model.Vulnerability.SeeAlso.Split('\n'))
                    {
                        if (!string.IsNullOrWhiteSpace(link))
                        {
                            <a href="@link.Trim()" target="_blank" class="d-block text-truncate mb-1">
                                @link.Trim()
                            </a>
                        }
                    }
                </div>
            </div>
        }
    </div>
</div>

<div class="mt-4">
    <a asp-action="Index" asp-route-hostId="@Model.Vulnerability.HostId" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left me-1"></i>Back to Host Vulnerabilities
    </a>
</div>
