@model VulnMgmt.Web.Models.ViewModels.SiteDetailsViewModel
@{
    ViewData["Title"] = Model.Site.Name;
}

<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a asp-action="Index">Sites</a></li>
        <li class="breadcrumb-item active">@Model.Site.Name</li>
    </ol>
</nav>

@if (TempData["Success"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle me-1"></i>@TempData["Success"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="mb-1">
            <i class="bi bi-building me-2"></i>@Model.Site.Name
            @if (Model.Site.IsActive)
            {
                <span class="badge bg-success fs-6">Active</span>
            }
            else
            {
                <span class="badge bg-secondary fs-6">Inactive</span>
            }
        </h1>
        @if (!string.IsNullOrEmpty(Model.Site.OrganizationName))
        {
            <p class="text-muted mb-0">@Model.Site.OrganizationName</p>
        }
    </div>
    <div>
        @if (User.IsInRole("Admin") || User.IsInRole("ISSM"))
        {
            <a asp-action="Edit" asp-route-id="@Model.Site.Id" class="btn btn-outline-primary">
                <i class="bi bi-pencil me-1"></i>Edit
            </a>
            <a asp-controller="Host" asp-action="Create" asp-route-siteId="@Model.Site.Id" class="btn btn-primary">
                <i class="bi bi-plus-lg me-1"></i>Add Host
            </a>
        }
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-info text-white h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="text-white-50">Total Hosts</h6>
                        <h2 class="mb-0">@Model.Summary.TotalHosts</h2>
                    </div>
                    <i class="bi bi-pc-display display-4 opacity-50"></i>
                </div>
                <small class="text-white-50">@Model.Summary.ActiveHosts active</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-dark h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="text-dark-50">Open Vulns</h6>
                        <h2 class="mb-0">@Model.Summary.TotalVulnerabilities</h2>
                    </div>
                    <i class="bi bi-bug display-4 opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-danger text-white h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="text-white-50">Critical</h6>
                        <h2 class="mb-0">@Model.Summary.CriticalCount</h2>
                    </div>
                    <i class="bi bi-exclamation-octagon display-4 opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-orange text-white h-100" style="background-color: #fd7e14;">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 style="color: rgba(255,255,255,0.7);">High</h6>
                        <h2 class="mb-0">@Model.Summary.HighCount</h2>
                    </div>
                    <i class="bi bi-exclamation-triangle display-4 opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header">
                <i class="bi bi-info-circle me-1"></i>Site Information
            </div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-sm-4">Location</dt>
                    <dd class="col-sm-8">@(Model.Site.Location ?? "-")</dd>

                    <dt class="col-sm-4">Description</dt>
                    <dd class="col-sm-8">@(Model.Site.Description ?? "-")</dd>

                    <dt class="col-sm-4">Last Scan</dt>
                    <dd class="col-sm-8">
                        @if (Model.Summary.LastScanDate.HasValue)
                        {
                            @Model.Summary.LastScanDate.Value.ToString("MM/dd/yyyy HH:mm")
                        }
                        else
                        {
                            <span class="text-muted">Never scanned</span>
                        }
                    </dd>

                    <dt class="col-sm-4">Created</dt>
                    <dd class="col-sm-8">@Model.Site.CreatedDate.ToString("MM/dd/yyyy")</dd>
                </dl>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header">
                <i class="bi bi-person me-1"></i>Point of Contact
            </div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-sm-4">Name</dt>
                    <dd class="col-sm-8">@(Model.Site.POCName ?? "-")</dd>

                    <dt class="col-sm-4">Email</dt>
                    <dd class="col-sm-8">
                        @if (!string.IsNullOrEmpty(Model.Site.POCEmail))
                        {
                            <a href="mailto:@Model.Site.POCEmail">@Model.Site.POCEmail</a>
                        }
                        else
                        {
                            <span>-</span>
                        }
                    </dd>

                    <dt class="col-sm-4">Phone</dt>
                    <dd class="col-sm-8">@(Model.Site.POCPhone ?? "-")</dd>
                </dl>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-pc-display me-1"></i>Hosts (@Model.Hosts.Count())</span>
        @if (User.IsInRole("Admin") || User.IsInRole("ISSM"))
        {
            <a asp-controller="Host" asp-action="Create" asp-route-siteId="@Model.Site.Id" class="btn btn-sm btn-primary">
                <i class="bi bi-plus-lg me-1"></i>Add Host
            </a>
        }
    </div>
    <div class="card-body p-0">
        @if (!Model.Hosts.Any())
        {
            <div class="p-4 text-center text-muted">
                <i class="bi bi-pc-display display-4"></i>
                <p class="mt-2">No hosts in this site yet.</p>
                @if (User.IsInRole("Admin") || User.IsInRole("ISSM"))
                {
                    <a asp-controller="Host" asp-action="Create" asp-route-siteId="@Model.Site.Id" class="btn btn-primary">
                        <i class="bi bi-plus-lg me-1"></i>Add Host
                    </a>
                    <span class="mx-2">or</span>
                    <a asp-controller="ScanImport" asp-action="Upload" asp-route-siteId="@Model.Site.Id" class="btn btn-outline-primary">
                        <i class="bi bi-upload me-1"></i>Import from Nessus
                    </a>
                }
            </div>
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Host</th>
                            <th>DNS Name</th>
                            <th>IP Address</th>
                            <th>OS</th>
                            <th class="text-center">Status</th>
                            <th class="text-center">Vulns</th>
                            <th class="text-center">Crit</th>
                            <th class="text-center">High</th>
                            <th>Last Scan</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var host in Model.Hosts)
                        {
                            <tr>
                                <td>
                                    <a asp-controller="Host" asp-action="Details" asp-route-id="@host.Id" class="fw-semibold text-decoration-none">
                                        @host.DisplayName
                                    </a>
                                </td>
                                <td><code class="small">@(host.DNSName ?? "-")</code></td>
                                <td><code class="small">@(host.LastKnownIPAddress ?? "-")</code></td>
                                <td class="small">@(host.OperatingSystem ?? "-")</td>
                                <td class="text-center">
                                    @switch (host.Status)
                                    {
                                        case VulnMgmt.Web.Models.Domain.HostStatus.Active:
                                            <span class="badge bg-success">Active</span>
                                            break;
                                        case VulnMgmt.Web.Models.Domain.HostStatus.Inactive:
                                            <span class="badge bg-secondary">Inactive</span>
                                            break;
                                        case VulnMgmt.Web.Models.Domain.HostStatus.Decommissioned:
                                            <span class="badge bg-dark">Decommissioned</span>
                                            break;
                                        default:
                                            <span class="badge bg-light text-dark">Unknown</span>
                                            break;
                                    }
                                </td>
                                <td class="text-center">
                                    @if (host.VulnCount > 0)
                                    {
                                        <span class="badge bg-warning text-dark">@host.VulnCount</span>
                                    }
                                    else
                                    {
                                        <span class="text-muted">0</span>
                                    }
                                </td>
                                <td class="text-center">
                                    @if (host.CriticalCount > 0)
                                    {
                                        <span class="badge bg-danger">@host.CriticalCount</span>
                                    }
                                    else
                                    {
                                        <span class="text-muted">0</span>
                                    }
                                </td>
                                <td class="text-center">
                                    @if (host.HighCount > 0)
                                    {
                                        <span class="badge" style="background-color: #fd7e14;">@host.HighCount</span>
                                    }
                                    else
                                    {
                                        <span class="text-muted">0</span>
                                    }
                                </td>
                                <td class="small">
                                    @if (host.LastScanDate.HasValue)
                                    {
                                        @host.LastScanDate.Value.ToString("MM/dd/yy")
                                    }
                                    else
                                    {
                                        <span class="text-muted">Never</span>
                                    }
                                </td>
                                <td class="text-end">
                                    <a asp-controller="Host" asp-action="Details" asp-route-id="@host.Id" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
</div>
