using Microsoft.EntityFrameworkCore;
using VulnMgmt.Web.Data;
using VulnMgmt.Web.Models.Domain;

namespace VulnMgmt.Web.Services;

public class VulnerabilityService : IVulnerabilityService
{
    private readonly ApplicationDbContext _context;

    public VulnerabilityService(ApplicationDbContext context)
    {
        _context = context;
    }

    public async Task<IEnumerable<HostVulnerability>> GetAllAsync()
    {
        return await _context.HostVulnerabilities
            .Include(v => v.Host)
            .ThenInclude(h => h.Site)
            .OrderByDescending(v => v.Severity)
            .ThenBy(v => v.PluginName)
            .ToListAsync();
    }

    public async Task<IEnumerable<HostVulnerability>> GetByHostAsync(int hostId)
    {
        return await _context.HostVulnerabilities
            .Where(v => v.HostId == hostId)
            .OrderByDescending(v => v.Severity)
            .ThenBy(v => v.PluginName)
            .ToListAsync();
    }

    public async Task<IEnumerable<HostVulnerability>> GetBySiteAsync(int siteId)
    {
        return await _context.HostVulnerabilities
            .Include(v => v.Host)
            .Where(v => v.Host.SiteId == siteId)
            .OrderByDescending(v => v.Severity)
            .ThenBy(v => v.PluginName)
            .ToListAsync();
    }

    public async Task<HostVulnerability?> GetByIdAsync(int id)
    {
        return await _context.HostVulnerabilities
            .Include(v => v.Host)
            .ThenInclude(h => h.Site)
            .FirstOrDefaultAsync(v => v.Id == id);
    }

    public async Task<HostVulnerability> CreateAsync(HostVulnerability vulnerability)
    {
        vulnerability.CreatedDate = DateTime.UtcNow;
        vulnerability.ModifiedDate = DateTime.UtcNow;

        _context.HostVulnerabilities.Add(vulnerability);
        await _context.SaveChangesAsync();

        return vulnerability;
    }

    public async Task<HostVulnerability> UpdateAsync(HostVulnerability vulnerability)
    {
        vulnerability.ModifiedDate = DateTime.UtcNow;

        _context.HostVulnerabilities.Update(vulnerability);
        await _context.SaveChangesAsync();

        return vulnerability;
    }

    public async Task UpdateRemediationStatusAsync(int id, RemediationStatus status, string? notes, string userName)
    {
        var vulnerability = await _context.HostVulnerabilities.FindAsync(id);
        if (vulnerability == null)
            throw new ArgumentException($"Vulnerability with ID {id} not found.");

        vulnerability.RemediationStatus = status;
        vulnerability.RemediationNotes = notes;
        vulnerability.ModifiedDate = DateTime.UtcNow;

        if (status == RemediationStatus.Remediated || status == RemediationStatus.Accepted || status == RemediationStatus.FalsePositive)
        {
            vulnerability.RemediationDate = DateTime.UtcNow;
        }

        await _context.SaveChangesAsync();
    }

    public async Task DeleteAsync(int id)
    {
        var vulnerability = await _context.HostVulnerabilities.FindAsync(id);
        if (vulnerability != null)
        {
            _context.HostVulnerabilities.Remove(vulnerability);
            await _context.SaveChangesAsync();
        }
    }

    public async Task<bool> ExistsAsync(int id)
    {
        return await _context.HostVulnerabilities.AnyAsync(v => v.Id == id);
    }

    public async Task<VulnerabilitySummary> GetSummaryAsync(int? siteId = null)
    {
        var query = _context.HostVulnerabilities.AsQueryable();

        if (siteId.HasValue)
        {
            query = query.Include(v => v.Host).Where(v => v.Host.SiteId == siteId.Value);
        }

        var vulns = await query.ToListAsync();
        var openStatuses = new[] { RemediationStatus.Open, RemediationStatus.InProgress };

        return new VulnerabilitySummary
        {
            TotalCount = vulns.Count,
            OpenCount = vulns.Count(v => v.RemediationStatus == RemediationStatus.Open),
            CriticalOpenCount = vulns.Count(v => v.Severity == Severity.Critical && openStatuses.Contains(v.RemediationStatus)),
            HighOpenCount = vulns.Count(v => v.Severity == Severity.High && openStatuses.Contains(v.RemediationStatus)),
            MediumOpenCount = vulns.Count(v => v.Severity == Severity.Medium && openStatuses.Contains(v.RemediationStatus)),
            LowOpenCount = vulns.Count(v => v.Severity == Severity.Low && openStatuses.Contains(v.RemediationStatus)),
            InfoOpenCount = vulns.Count(v => v.Severity == Severity.Info && openStatuses.Contains(v.RemediationStatus)),
            RemediatedCount = vulns.Count(v => v.RemediationStatus == RemediationStatus.Remediated),
            AcceptedCount = vulns.Count(v => v.RemediationStatus == RemediationStatus.Accepted || v.RemediationStatus == RemediationStatus.FalsePositive),
            InProgressCount = vulns.Count(v => v.RemediationStatus == RemediationStatus.InProgress)
        };
    }

    public async Task<IEnumerable<HostVulnerability>> SearchAsync(VulnerabilitySearchCriteria criteria)
    {
        var query = _context.HostVulnerabilities
            .Include(v => v.Host)
            .ThenInclude(h => h.Site)
            .AsQueryable();

        if (criteria.SiteId.HasValue)
        {
            query = query.Where(v => v.Host.SiteId == criteria.SiteId.Value);
        }

        if (criteria.HostId.HasValue)
        {
            query = query.Where(v => v.HostId == criteria.HostId.Value);
        }

        if (criteria.Severity.HasValue)
        {
            query = query.Where(v => v.Severity == criteria.Severity.Value);
        }

        if (criteria.Status.HasValue)
        {
            query = query.Where(v => v.RemediationStatus == criteria.Status.Value);
        }

        if (!string.IsNullOrEmpty(criteria.SearchTerm))
        {
            var term = criteria.SearchTerm.ToLower();
            query = query.Where(v =>
                (v.PluginName != null && v.PluginName.ToLower().Contains(term)) ||
                (v.Synopsis != null && v.Synopsis.ToLower().Contains(term)) ||
                (v.CVE != null && v.CVE.ToLower().Contains(term)));
        }

        if (!string.IsNullOrEmpty(criteria.CVE))
        {
            query = query.Where(v => v.CVE != null && v.CVE.Contains(criteria.CVE));
        }

        if (criteria.PluginId.HasValue)
        {
            query = query.Where(v => v.PluginId == criteria.PluginId.Value);
        }

        if (criteria.IsExploitable.HasValue)
        {
            query = query.Where(v => v.IsExploitable == criteria.IsExploitable.Value);
        }

        var skip = (criteria.PageNumber - 1) * criteria.PageSize;

        return await query
            .OrderByDescending(v => v.Severity)
            .ThenByDescending(v => v.LastObserved)
            .ThenBy(v => v.PluginName)
            .Skip(skip)
            .Take(criteria.PageSize)
            .ToListAsync();
    }
}
